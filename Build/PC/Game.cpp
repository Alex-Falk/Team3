//'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''%%'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
//''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''%&&&''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
//'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''&@@@&%'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
//'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''&@@@@@&''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
//'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''&@@@@@@&''''''''''''''''''''''''''#&@@@@@@@@@@&''''''''''''''''''''''''''''
//'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''&@@@@@@@@@&'''''''''''''''''''#@@@@@@@@@@@'''''''''''''''''''''''''''''''''''''
//''''''''''''''''''''''''''''''''''''''''''''''''''''''''%&@&@%@@@@@@@@@@@#'#&@@@@@@@@@@@@&@@@@@@@@@&''''''''''''''''''''''''''''''''''''''''
//''''''''''''''''''''''''''''''''''''''''''''''''''''#&&&&@@@@@@@@@@@@@@@@@@@@@@&@@@@@@@@@@@@@@@@@@@@@@@'''''''''''''''''''''''''''''''''''''
//'''''''''''''''''''''''''''''''''''''''''''''''''''%%''''%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@''''''''''''''''''''''''''''''''''''''''
//''''''''''''''''''''''''''''''''''''''''''''''''''''''''%@@@&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#'''''''''''''''''''''''''''''''''''
//'''''''''''''''''''''''''''''''''''''''''''''''''''%@@@@&#%&@@@@@@@@@@@@@@&&@@@@&@@@@@@@@@@@@@@@@@@@@@@@@@''''''''''''''''''''''''''''''''''
//''''''''''''''''''''''''''''''''''''''''''''''%&&@@@@@&%%%%&@@@@@@@@@@&%@@@@@%''''#&@@@@@@@@@@@@@@@@&''''#&@@@''''''''''''''''''''''''''''''
//''''''''''''''''''''''''''''''''''''''''#&@&@@@@@@@@@@@@@@@@@@@@@@@@@&'''&@&&%'''''''#&@@@@@@@@@@@@@@@@@''''''@@''''''''''''''''''''''''''''
//'''''''''''''''''''''''''''''''''''''''&@@@@@@@@@@@@@@@@@@@@@@@@@&&%#''''#@&&'''''''''&@@@@@@@@@@@@@@@@@@@&''''*''''''''''''''''''''''''''''
//'''''''''''''''''''''''''''''''''''''''%@&@@@@'''''''#####%%#''''''''''#%''''''''''&@@@@@@@@@@@@@@@@@@@@@@''''''''''''''''''''''''''''''''''
//''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''#&@@@@@@@@@@@@@@@&@@@@@@@@&'''''''''''''''''''''''''''''''
//'''''''''''''''''''''''''''''''''''''''''''''#&@&&%%#'''''''''''''''''''''''''#%&@@@@@@@@@@@@@@@&&&'''#@@@@@@'''''''''''''''''''''''''''''''
//''''''''''''''''''''''''''''''''''''''''''''''''#@@@@@@@@@@&&&&&&&&@@@@@@@@@@@@@@@@@@@@@@@@@@@@&''''''@@@@@'''''''''''''''''''''''''''''''''
//'''''''''''''''''''''''''''''''''''''''''''''''''''%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&%''''''''%@@@@'''''''''''''''''''''''''''''''
//''''''''''''''''''''''''''''''''''''''''''''''''''%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&'''''''''''@@@''''''''''''''''''''''''''''''''
//''''''''''''''''''''''''''''''''''''''''''''''%&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%'''''''''''''@@'''''''''''''''''''''''''''''''''
//''''''''''''''''''''''''''''''''''''''''''#&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@''''''''''''''''''''''''''''''''''''''''''''''''''''
//''''''''''''''''''''''''''''''''''''''''%&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&%%#&@@@@@@@&'''''''''''''''''''''''''''''''''''''''''''''''''''''
//''''''''''''''''''''''''''''''''''''''&@@@@@@@@@@@@@@@@@@@@@@@@@@@&%#'''''''%@@@@@@'''''''''''''''''''''''''''''''''''''''''''''''''''''''''
//''''''''''''''''''''''''''''''''''''%@@@@@@@@@@@@@@@@@@@@@@@@&%'''''''''''%&@@@@@'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
//''''''''''''''''''''''''''''''''''#&@@@@@@@@@@@@@@@@@@%@@%'''''''''''#&@@@@&%'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
//'''''''''''''''''''''''''''''''''%@@@@@@@@@@@@@@@@@@#''%@%''''''''''#&@@@'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
//''''''''''''''''''''''''''''''''%@@@@@@@@@@@@@@@@@@#'''#'''''''''%&@&&%#''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
//'''''''''''''''''''''''''''''''%@@@@@@@@@@@@@@@@@@#'''''''''''%&&%#'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
//''''''''''''''''''''''''''''''%@@#&@@@@@@@@@@@@@@&'''''''''''''''''''''''''''''''''#&@&&%#''''''''''''''''''''''''''''''''''''''''''''''''''
//'''''''''''''''''''''''''''''#&&'%@@@@@@@@@@@@@@&''''''''''''''''''''''''''''''''''''''#&@@@@@&#''''''''''''''''''''''''''''''''''''''''''''
//''''''''''''''''''''''''''''''#@@@@@@@@@@@&@@@&'''''''''''''''''''''''''''''''''''''''''#@@@@@@@@@@&%'''''''''''''''''''''''''''''''''''''''
//''''''''''''''''''''''''''''''''&@@@@@@@@@@#'#&@@#''''''''''''''''''''''''''''''''''''''''''%@@@@@@@@@@@@%#'''''''''''''''''''''''''''''''''
//''''''''''''''''''''''''''''''''&@@@@@@@@@@'''''##''''''''''''''''''''''''#&@&%''''#%&@@@@@@&%@@@@@@@@@@@@@@%'''''''''''''''''''''''''''''''
//''''''''''''''''''''''''''''''''&@@@@@@@@@@''''''''''''''''''''''''''''''#@@@@%''''#%&@@@@@@@@@@@@@@@@@@@@@@#'''''''''''''''''''''''''''''''
//''''''''''''''''''''''''''''''''&@@@@@@@@@@@@@''''''''#%&&@@&'''''''''''#&@@@@@&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@''''''''''''''''''''''''''''''
//''''''''''''''''''''''''''''''''%@@@@@@@@@@@@@@@@@@@@@@@@@@'''''''''''%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%&@@@@@@@&'''''''''''''''''''''''''''''
//'''''''''''''''''''''''''''''''''&@@@@@@@@@@@@@@@@@@@@@&%#''''''##%&&@@@@@@@@@@@@@@@@@@@@&%%%###'''#%&&@%''%@@@@@#''''''''''''''''''''''''''
//''''''''''''''''''''''''''''''''''&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%''''''''''''''''#&%''#@@@@%''''''''''''''''''''''''''
//''''''''''''''''''''''''''''''''''%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&&@''''''''''''''#'''&@@@%''''''''''''''''''''''''''
//''''''''''''''''''''''''''''''''''&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&&%#''''''''''''''''''''&@@@%''''''''''''''''''''''''''
//''''''''''''''''''''''''''''''''''@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&%''%@@@@@@@''''''#&%''''''''''''&@@@%''''''''''''''''''''''''''''
//'''''''''''''''''''''''''''''''''#@@@@@@%#&@@@@@@@@@@@@@@@@@@@@@@@@@@@@'''''''#&@@@@@&@@@@@@&''''''''''''''&@@@'''''''''''''''''''''''''''''
//'''''''''''''''''''''''''''''''''&@@@@&'''''''%&@@@@@@@@@@@@@&@@@@@@@@@@#''''''''''''#####''''''''''''''''''#@@@&'''''''''''''''''''''''''''
//'''''''''''''''''''''''''''''''''@@@@@#'''''''''''''##%%&&@@@&%#%@@@@@@@@&''''''''''''''''''''''''''''''''''#@@@%'''''''''''''''''''''''''''
//''''''''''''''''''''''''''''''''%@@@&''''''''''''''''''''''''''''''%@@@@@@&'''''''''''''''''''''''''''''''''&@@@''''''''''''''''''''''''''''
//''''''''''''''''''''''''''''''''@@@&'''''''''''''''''''''''''''''''''&@@@@@&'''''''''''''''''''''''''''''''%@@@#''''''''''''''''''''''''''''
//'''''''''''''''''''''''''''''''&@@%'''''''''''''''''''''''''''''''''''%@@@@@&'''''''''''''''''''''''''''''#@@@%'''''''''''''''''''''''''''''
//''''''''''''''''''''''''''''''%@&''''''''''''''''''''''''''''''''''''''#@@@@@%''''''''''''''''''''''''''''&@&%''''''''''''''''''''''''''''''
//''''''''''''''''''''''''''''''&&'''''''''''''''''''''''''''''''''''''''''&@@@@#''''''''''''''''''''''''''&&&&'''''''''''''''''''''''''''''''
//''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''#&@@%'''''''''''''''''''''''''&&&&''''''''''''''''''''''''''''''''
//''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''%@&''''''''''''''''''''''''%&&%'''''''''''''''''''''''''''''''''
//'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''#'''''''''''''''''''''#&&&'''''''''''''''''''''''''''''''''''''
//''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''#&'''''''''''''''''''''&&%''''''''''''''''''''''''''''''''''''
//''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''#'''''''''''''''''''#&%''''''''''''''''''''''''''''''''''''''
//''''''''''''''''''''''''''''''%'''@@@'#@@@@@@''''''''''''''''''''''''''''''''''''''''''''''''''''''%%''''''''''''''''''''''''''''''''''''''''
//'''''''''''''''''''''''''''''#@@#'#@''&@'&'''''''''''''''''''''''''''''''''''''''''''''''''''''''#%''''''''''''''''''''''''''''''''''''''''''
//''''''''''''''''''''''''''''%@'%@@@''@%&@%''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
//'''''''''''''''''''''''''''&@''@&''@@&'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

#include "Game.h"
#include <ncltech\SceneManager.h>
void Game::Update(float dt)
{ 
	if (user) 
	{
		user->UpdateUser(dt); 
	} 

}

void Game::BuildGroundScore() {


	for (int i = 0; i < xOnGrid - 1; i++) {
		for (int j = 0; j < yOnGrid - 1; j++) {
			ground[i][j] = START_COLOUR;
		}
	}

	ground[0][0] = RED;
	ground[0][yOnGrid - 1] = GREEN;
	ground[xOnGrid - 1][0] = BLUE;
	ground[xOnGrid - 1][yOnGrid - 1] = PINK;
	for (int i = 0; i < 4; i++)
	{
		groundTeamScore[i] = 0;
	}
}

void Game::UpdateGroundScore(ControllableAvatar* player) {

	Vector2 playerPos = Vector2((player->GetPosition().x * groundScoreAccuracy) + xOnGrid / 2, (player->GetPosition().z * groundScoreAccuracy) + yOnGrid / 2);
	int plGridSize = (int)(player->GetLife() * groundScoreAccuracy / 100);

	// Runs through the square arount the center and finds the circle.
	for (int i = (int)playerPos.x - plGridSize; i <= (int)playerPos.x; i++) {
		for (int j = (int)playerPos.y - plGridSize; j <= (int)playerPos.y; j++) {
			if ((i - playerPos.x)*(i - playerPos.x) + (j - playerPos.y)* (j - playerPos.y) <= plGridSize * plGridSize) {
				int xSym = (int)(playerPos.x - (i - playerPos.x));
				int ySym = (int)(playerPos.y - (j - playerPos.y));
				// Thanks to symetry we take all 4 quadrants of the circle arount the center
				if (xSym < xOnGrid - 1 && xSym > 0 && ySym < yOnGrid - 1 && ySym > 0 && i > 0 && j > 0 && i < xOnGrid - 1 && j < yOnGrid - 1)
				{
					ChangeGridScore(ground[i][j], player->GetColour());
					ground[i][j] = player->GetColour();
					ChangeGridScore(ground[i][ySym], player->GetColour());
					ground[i][ySym] = player->GetColour();
					ChangeGridScore(ground[xSym][j], player->GetColour());
					ground[xSym][j] = player->GetColour();
					ChangeGridScore(ground[xSym][ySym], player->GetColour());
					ground[xSym][ySym] = player->GetColour();
				}
			}
		}
	}
}

// Decreases the score from previous team and increases the score to the new team.
void Game::ChangeGridScore(Colour teamToDecrease, Colour teamToIncrease) {
	groundTeamScore[teamToDecrease] -= 1;
	groundTeamScore[teamToIncrease] += 1;
}

void Game::PrintScore(int score) {
	NCLDebug::Log(to_string(score / 1000));
}
void Game::ResetGame()
{
	for (uint i = 0; i < 4; ++i)
	{
		SceneManager::Instance()->GetCurrentScene()->RemoveGameObject(avatars[i]);
		delete avatars[i];
		avatars[i] = nullptr;
	}
	delete user;
	user = nullptr;
	enet_deinitialize();
}